<div class="space-y-8" data-controller="realtime-metrics" data-realtime-metrics-project-id-value="<%= current_project.id %>">

  <!-- Time range selector -->
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-[22px] font-semibold tracking-tight pulse-text">Overview</h1>
      <p class="text-[14px] mt-1 pulse-text-muted">
        Application performance at a glance
        <span class="inline-flex items-center gap-1.5 ml-2 px-2 py-0.5 rounded-full text-[11px] font-medium pulse-live-badge">
          <span class="w-1.5 h-1.5 rounded-full animate-pulse pulse-live-dot"></span>
          Live
        </span>
      </p>
    </div>
    <div class="flex gap-2">
      <% %w[1h 6h 24h 7d].each do |range| %>
        <% active = params[:since] == range || (params[:since].nil? && range == '1h') %>
        <%= link_to range, dashboard_overview_path(since: range),
            class: "px-3 py-1.5 text-[13px] font-medium rounded-lg #{active ? 'pulse-btn-active' : 'pulse-btn-inactive'}" %>
      <% end %>
    </div>
  </div>

  <!-- Key metrics cards -->
  <div class="grid grid-cols-4 gap-4">
    <!-- Apdex -->
    <div class="rounded-xl p-5 pulse-card">
      <div class="flex items-center justify-between">
        <span class="text-[13px] pulse-text-muted">Apdex</span>
        <span class="w-3 h-3 rounded-full <%= apdex_color(@overview[:apdex]) %>" data-realtime-metrics-target="apdexIndicator"></span>
      </div>
      <p class="text-[28px] font-semibold mt-2 pulse-text" data-realtime-metrics-target="apdex"><%= @overview[:apdex] %></p>
      <p class="text-[12px] mt-1 pulse-text-muted">T = <%= current_project.apdex_t %>s</p>
    </div>

    <!-- Throughput -->
    <div class="rounded-xl p-5 pulse-card">
      <span class="text-[13px] pulse-text-muted">Throughput</span>
      <p class="text-[28px] font-semibold mt-2 pulse-text" data-realtime-metrics-target="throughput"><%= number_with_delimiter(@overview[:rpm]) %></p>
      <p class="text-[12px] mt-1 pulse-text-muted">requests/min</p>
    </div>

    <!-- Response Time -->
    <div class="rounded-xl p-5 pulse-card">
      <span class="text-[13px] pulse-text-muted">Response Time</span>
      <p class="text-[28px] font-semibold mt-2 pulse-text" data-realtime-metrics-target="responseTime"><%= @overview[:avg_duration]&.round(0) || '—' %><span class="text-[16px] font-normal">ms</span></p>
      <p class="text-[12px] mt-1 pulse-text-muted">
        <span data-realtime-metrics-target="responseTimeP95">P95: <%= @overview[:p95_duration]&.round(0) || '-' %>ms</span>
        <span data-realtime-metrics-target="responseTimeP99">P99: <%= @overview[:p99_duration]&.round(0) || '-' %>ms</span>
      </p>
    </div>

    <!-- Error Rate -->
    <div class="rounded-xl p-5 pulse-card">
      <div class="flex items-center justify-between">
        <span class="text-[13px] pulse-text-muted">Error Rate</span>
        <span class="w-2 h-2 rounded-full <%= @overview[:error_rate] > 1 ? '' : 'hidden' %>" style="background: var(--pulse-error);" data-realtime-metrics-target="errorIndicator"></span>
      </div>
      <p class="text-[28px] font-semibold mt-2 <%= @overview[:error_rate] > 1 ? 'pulse-error' : 'pulse-text' %>" data-realtime-metrics-target="errorRate">
        <%= @overview[:error_rate] %>%
      </p>
      <p class="text-[12px] mt-1 pulse-text-muted" data-realtime-metrics-target="errorCount"><%= @overview[:error_count] %> errors</p>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-2 gap-6">
    <!-- Throughput chart -->
    <div class="rounded-xl p-5 pulse-card">
      <h3 class="text-[14px] font-medium mb-4 pulse-text">Throughput</h3>
      <div class="h-48 pulse-chart-container" data-controller="chart" data-chart-type-value="line" data-chart-metric-value="throughput" data-chart-data-value="<%= @throughput_data.to_json %>">
        <canvas></canvas>
      </div>
    </div>

    <!-- Response time chart -->
    <div class="rounded-xl p-5 pulse-card">
      <h3 class="text-[14px] font-medium mb-4 pulse-text">Response Time</h3>
      <div class="h-48 pulse-chart-container" data-controller="chart" data-chart-type-value="line" data-chart-metric-value="response_time" data-chart-data-value="<%= @response_time_data.to_json %>">
        <canvas></canvas>
      </div>
    </div>
  </div>

  <!-- Slow requests -->
  <div class="rounded-xl pulse-card">
    <div class="p-5 flex justify-between items-center pulse-card-inner-border" style="border-bottom-width: 1px; border-bottom-style: solid;">
      <h3 class="text-[14px] font-medium pulse-text">Slow Requests</h3>
      <%= link_to "View all →", dashboard_requests_path(slow: true), class: "text-[13px] hover:opacity-70 pulse-text-secondary" %>
    </div>

    <div>
      <% @slow_requests.each do |trace| %>
        <%= link_to dashboard_trace_path(trace.trace_id), class: "flex items-center gap-4 p-4 hover:opacity-80 pulse-table-row" do %>
          <span class="text-[18px] font-semibold w-20 text-right pulse-text-muted"><%= trace.duration_ms&.round(0) || '-' %><span class="text-[12px]">ms</span></span>
          <div class="flex-1 min-w-0">
            <p class="text-[14px] font-medium truncate pulse-text"><%= trace.name %></p>
            <p class="text-[13px] pulse-text-muted"><%= time_ago_in_words(trace.started_at) %> ago</p>
          </div>
          <div class="text-right text-[13px] pulse-text-muted">
            <p>DB: <%= trace.db_duration_ms&.round(0) || 0 %>ms</p>
            <p>View: <%= trace.view_duration_ms&.round(0) || 0 %>ms</p>
          </div>
        <% end %>
      <% end %>

      <% if @slow_requests.empty? %>
        <div class="p-8 text-center text-[14px] pulse-text-muted">
          No slow requests
        </div>
      <% end %>
    </div>
  </div>
</div>
