<div class="space-y-6">
  <!-- Header with title and controls -->
  <div class="flex justify-between items-start">
    <div>
      <h1 class="text-[22px] font-semibold tracking-tight pulse-text">Endpoints</h1>
      <p class="text-[14px] mt-1 pulse-text-muted">Performance breakdown by endpoint</p>
    </div>
    <div class="flex gap-2">
      <% %w[1h 6h 24h 7d].each do |range| %>
        <% active = params[:since] == range || (params[:since].nil? && range == '1h') %>
        <%= link_to range, dashboard_endpoints_path(since: range, search: @search, group_by: @group_by, method: @method_filter),
            class: "px-3 py-1.5 text-[13px] font-medium rounded-lg #{active ? 'pulse-btn-active' : 'pulse-btn-inactive'}" %>
      <% end %>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="flex items-center gap-4">
    <!-- Search -->
    <%= form_with url: dashboard_endpoints_path, method: :get, local: true, class: "flex-1 max-w-md" do %>
      <%= hidden_field_tag :since, params[:since] %>
      <%= hidden_field_tag :group_by, @group_by %>
      <%= hidden_field_tag :method, @method_filter %>
      <div class="relative">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 pulse-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <%= text_field_tag :search, @search,
            placeholder: "Search endpoints...",
            class: "w-full pl-10 pr-4 py-2 text-[14px] rounded-lg pulse-input" %>
      </div>
    <% end %>

    <!-- Group By Toggle -->
    <div class="flex rounded-lg overflow-hidden pulse-border" style="border-width: 1px; border-style: solid;">
      <%= link_to "Endpoints", dashboard_endpoints_path(since: params[:since], search: @search, group_by: 'endpoint', method: @method_filter),
          class: "px-3 py-2 text-[13px] font-medium #{@group_by == 'endpoint' ? 'pulse-btn-active' : 'pulse-surface pulse-text-secondary'}" %>
      <%= link_to "Groups", dashboard_endpoints_path(since: params[:since], search: @search, group_by: 'prefix', method: @method_filter),
          class: "px-3 py-2 text-[13px] font-medium #{@group_by == 'prefix' ? 'pulse-btn-active' : 'pulse-surface pulse-text-secondary'}" %>
    </div>

    <!-- Method Filter -->
    <select onchange="window.location.href=this.value" class="px-3 py-2 text-[13px] rounded-lg pulse-input">
      <option value="<%= dashboard_endpoints_path(since: params[:since], search: @search, group_by: @group_by) %>" <%= 'selected' if @method_filter.blank? %>>All Methods</option>
      <% %w[GET POST PUT PATCH DELETE].each do |method| %>
        <option value="<%= dashboard_endpoints_path(since: params[:since], search: @search, group_by: @group_by, method: method) %>" <%= 'selected' if @method_filter == method %>><%= method %></option>
      <% end %>
    </select>
  </div>

  <!-- Path Prefix Quick Filters -->
  <% if @path_prefixes.any? && @group_by != 'prefix' %>
    <div class="flex flex-wrap gap-2">
      <span class="text-[12px] font-medium py-1 pulse-text-muted">Quick filters:</span>
      <% @path_prefixes.each do |prefix, count| %>
        <%= link_to dashboard_endpoints_path(since: params[:since], search: prefix, group_by: @group_by, method: @method_filter),
            class: "px-2 py-1 text-[12px] rounded-md hover:opacity-80 pulse-success-badge" do %>
          <%= prefix %> <span class="pulse-text-muted">(<%= number_with_delimiter(count) %>)</span>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <!-- Table -->
  <div class="rounded-xl overflow-hidden pulse-card">
    <table class="w-full">
      <thead class="pulse-table-header">
        <tr class="text-left text-[13px]">
          <th class="p-4 font-medium">
            <%= link_to dashboard_endpoints_path(since: params[:since], search: @search, group_by: @group_by, method: @method_filter, sort: 'name', sort_dir: @sort == 'name' && @sort_dir == 'asc' ? 'desc' : 'asc') do %>
              <%= @group_by == 'prefix' ? 'Group' : 'Endpoint' %>
              <% if @sort == 'name' %>
                <span><%= @sort_dir == 'asc' ? '↑' : '↓' %></span>
              <% end %>
            <% end %>
          </th>
          <th class="p-4 font-medium">
            <%= link_to dashboard_endpoints_path(since: params[:since], search: @search, group_by: @group_by, method: @method_filter, sort: 'count', sort_dir: @sort == 'count' && @sort_dir == 'desc' ? 'asc' : 'desc') do %>
              Requests
              <% if @sort == 'count' %>
                <span><%= @sort_dir == 'asc' ? '↑' : '↓' %></span>
              <% end %>
            <% end %>
          </th>
          <th class="p-4 font-medium">
            <%= link_to dashboard_endpoints_path(since: params[:since], search: @search, group_by: @group_by, method: @method_filter, sort: 'avg', sort_dir: @sort == 'avg' && @sort_dir == 'desc' ? 'asc' : 'desc') do %>
              Avg
              <% if @sort == 'avg' %>
                <span><%= @sort_dir == 'asc' ? '↑' : '↓' %></span>
              <% end %>
            <% end %>
          </th>
          <th class="p-4 font-medium">
            <%= link_to dashboard_endpoints_path(since: params[:since], search: @search, group_by: @group_by, method: @method_filter, sort: 'p95', sort_dir: @sort == 'p95' && @sort_dir == 'desc' ? 'asc' : 'desc') do %>
              P95
              <% if @sort == 'p95' %>
                <span><%= @sort_dir == 'asc' ? '↑' : '↓' %></span>
              <% end %>
            <% end %>
          </th>
          <th class="p-4 font-medium">P99</th>
          <th class="p-4 font-medium">Max</th>
          <th class="p-4 font-medium">
            <%= link_to dashboard_endpoints_path(since: params[:since], search: @search, group_by: @group_by, method: @method_filter, sort: 'errors', sort_dir: @sort == 'errors' && @sort_dir == 'desc' ? 'asc' : 'desc') do %>
              Error Rate
              <% if @sort == 'errors' %>
                <span><%= @sort_dir == 'asc' ? '↑' : '↓' %></span>
              <% end %>
            <% end %>
          </th>
          <% if @group_by == 'prefix' %>
            <th class="p-4 font-medium">Endpoints</th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @endpoints.each do |endpoint| %>
          <% if @group_by == 'prefix' %>
            <tr class="hover:opacity-80 cursor-pointer pulse-table-row" onclick="window.location='<%= dashboard_endpoints_path(since: params[:since], search: endpoint.prefix, group_by: 'endpoint') %>'">
          <% else %>
            <tr class="hover:opacity-80 cursor-pointer pulse-table-row" onclick="window.location='<%= dashboard_endpoint_path(endpoint.name, since: params[:since]) %>'">
          <% end %>
            <td class="p-4 text-[14px] font-medium pulse-text">
              <% if @group_by == 'prefix' %>
                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4 pulse-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                  </svg>
                  <%= endpoint.name %>
                </div>
              <% else %>
                <%= link_to endpoint.name, dashboard_endpoint_path(endpoint.name, since: params[:since]), class: "pulse-text" %>
              <% end %>
            </td>
            <td class="p-4 text-[13px] pulse-text"><%= number_with_delimiter(endpoint.count) %></td>
            <td class="p-4 font-mono text-[13px] pulse-text"><%= endpoint.avg_duration.to_f.round(0) %>ms</td>
            <td class="p-4 font-mono text-[13px]">
              <% p95 = endpoint.p95_duration.to_f %>
              <span class="<%= p95 > 1000 ? 'pulse-error' : p95 > 500 ? 'pulse-warning' : 'pulse-text' %>">
                <%= p95.round(0) %>ms
              </span>
            </td>
            <td class="p-4 font-mono text-[13px] pulse-text-muted">
              <%= endpoint.p99_duration.to_f.round(0) %>ms
            </td>
            <td class="p-4 font-mono text-[13px] pulse-text-muted"><%= endpoint.max_duration.to_f.round(0) %>ms</td>
            <td class="p-4">
              <% error_rate = endpoint.respond_to?(:error_rate) ? endpoint.error_rate.to_f : (endpoint.error_count.to_f / endpoint.count * 100) %>
              <span class="text-[13px] <%= error_rate > 1 ? 'pulse-error' : 'pulse-success' %>">
                <%= error_rate.round(2) %>%
              </span>
            </td>
            <% if @group_by == 'prefix' %>
              <td class="p-4 text-[13px] pulse-text-muted"><%= endpoint.endpoint_count %></td>
            <% end %>
          </tr>
        <% end %>

        <% if @endpoints.empty? %>
          <tr>
            <td colspan="<%= @group_by == 'prefix' ? 8 : 7 %>" class="p-8 text-center text-[14px] pulse-text-muted">
              <% if @search.present? %>
                No endpoints matching "<%= @search %>"
              <% else %>
                No endpoints found
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Summary Stats -->
  <% if @endpoints.any? %>
    <div class="flex items-center justify-between text-[12px] pulse-text-muted">
      <span>Showing <%= @endpoints.to_a.count %> <%= @group_by == 'prefix' ? 'groups' : 'endpoints' %></span>
      <span>
        Total requests: <%= number_with_delimiter(@endpoints.to_a.sum { |e| e.count.to_i }) %>
      </span>
    </div>
  <% end %>
</div>
