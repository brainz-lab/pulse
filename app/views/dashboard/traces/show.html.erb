<div class="space-y-6">
  <!-- Header -->
  <div class="flex items-center gap-4">
    <%= link_to "â† Back", dashboard_requests_path, class: "text-[13px] hover:opacity-70", style: "color: #8B8780;" %>
    <div class="flex-1">
      <div class="flex items-center justify-between">
        <h1 class="text-[22px] font-semibold tracking-tight" style="color: #1A1A1A;"><%= @trace.name %></h1>
        <div class="flex items-center gap-3">
          <span class="text-[28px] font-semibold" style="color: #1A1A1A;"><%= @trace.duration_ms&.round(0) || '-' %><span class="text-[16px] font-normal">ms</span></span>
          <span class="text-[11px] px-2 py-1 rounded font-medium" style="background: <%= duration_badge_bg(@trace.duration_ms) %>; color: <%= duration_color(@trace.duration_ms) %>;"><%= duration_label(@trace.duration_ms) %></span>
        </div>
      </div>
      <p class="text-[14px] mt-1" style="color: #8B8780;"><%= @trace.started_at.strftime('%b %d, %Y at %H:%M:%S') %></p>
    </div>
  </div>

  <!-- Breakdown Bar -->
  <div class="rounded-xl p-5" style="background: #FFFFFE; border: 1px solid #E8E5E0;">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-[14px] font-medium" style="color: #1A1A1A;">Time Breakdown</h3>
      <div class="flex items-center gap-2">
        <span class="w-2 h-2 rounded-full" style="background: <%= @trace.error ? '#DC2626' : '#22C55E' %>;"></span>
        <span class="text-[13px]" style="color: <%= @trace.error ? '#DC2626' : '#22C55E' %>;"><%= @trace.status || (@trace.error ? 'Error' : 'OK') %></span>
      </div>
    </div>

    <!-- Stacked Bar -->
    <div class="h-8 rounded-lg overflow-hidden flex" style="background: #F0EFED;">
      <% if @trace.duration_ms && @trace.duration_ms > 0 %>
        <% db_pct = ((@trace.db_duration_ms || 0) / @trace.duration_ms * 100).round(1) %>
        <% view_pct = ((@trace.view_duration_ms || 0) / @trace.duration_ms * 100).round(1) %>
        <% ext_pct = ((@trace.external_duration_ms || 0) / @trace.duration_ms * 100).round(1) %>
        <% other_pct = [100 - db_pct - view_pct - ext_pct, 0].max %>

        <% if other_pct > 0 %>
          <div class="h-full" style="width: <%= other_pct %>%; background: #6366F1;"></div>
        <% end %>
        <% if db_pct > 0 %>
          <div class="h-full" style="width: <%= db_pct %>%; background: #8B5CF6;"></div>
        <% end %>
        <% if ext_pct > 0 %>
          <div class="h-full" style="width: <%= ext_pct %>%; background: #3B82F6;"></div>
        <% end %>
        <% if view_pct > 0 %>
          <div class="h-full" style="width: <%= view_pct %>%; background: #22C55E;"></div>
        <% end %>
      <% end %>
    </div>

    <!-- Legend -->
    <div class="flex gap-6 mt-4 text-[13px]" style="color: #6B6760;">
      <span class="flex items-center gap-2">
        <span class="w-2.5 h-2.5 rounded" style="background: #6366F1;"></span>
        Controller: <%= (@trace.duration_ms.to_f - (@trace.db_duration_ms || 0) - (@trace.view_duration_ms || 0) - (@trace.external_duration_ms || 0)).round(0) %>ms
      </span>
      <span class="flex items-center gap-2">
        <span class="w-2.5 h-2.5 rounded" style="background: #8B5CF6;"></span>
        Database: <%= @trace.db_duration_ms&.round(0) || 0 %>ms
      </span>
      <span class="flex items-center gap-2">
        <span class="w-2.5 h-2.5 rounded" style="background: #3B82F6;"></span>
        External: <%= @trace.external_duration_ms&.round(0) || 0 %>ms
      </span>
      <span class="flex items-center gap-2">
        <span class="w-2.5 h-2.5 rounded" style="background: #22C55E;"></span>
        View: <%= @trace.view_duration_ms&.round(0) || 0 %>ms
      </span>
    </div>
  </div>

  <% if @trace.error %>
    <!-- Error details -->
    <div class="rounded-xl p-5" style="background: #FEF2F2; border: 1px solid #FECACA;">
      <h3 class="text-[14px] font-medium" style="color: #DC2626;"><%= @trace.error_class || 'Error' %></h3>
      <p class="text-[13px] mt-2" style="color: #991B1B;"><%= @trace.error_message %></p>
    </div>
  <% end %>

  <!-- Spans -->
  <div class="rounded-xl" style="background: #FFFFFE; border: 1px solid #E8E5E0;">
    <div class="p-5" style="border-bottom: 1px solid #F0EFED;">
      <h3 class="text-[14px] font-medium" style="color: #1A1A1A;">Spans</h3>
    </div>

    <div class="divide-y" style="border-color: #F0EFED;">
      <% @trace.waterfall.each do |span| %>
        <div class="p-4">
          <div class="flex items-center gap-3 mb-2">
            <span class="text-[11px] font-medium uppercase px-2 py-0.5 rounded"
                  style="background: <%= span_kind_bg(span[:kind]) %>; color: <%= span_kind_color(span[:kind]) %>;">
              <%= span[:kind] %>
            </span>
            <span class="text-[14px] font-medium flex-1 truncate" style="color: #1A1A1A;"><%= span[:name] %></span>
            <span class="text-[13px] font-mono" style="color: #8B8780;"><%= span[:duration_ms]&.round(2) %>ms</span>
          </div>

          <!-- Span bar -->
          <div class="flex items-center gap-3">
            <span class="text-[11px] font-mono w-12 text-right" style="color: #8B8780;">+<%= span[:offset_ms].round(0) %></span>
            <div class="flex-1 h-2 rounded-full" style="background: #F0EFED;">
              <% if @trace.duration_ms && @trace.duration_ms > 0 %>
                <div class="h-full rounded-full"
                     style="margin-left: <%= (span[:offset_ms] / @trace.duration_ms * 100).round(2) %>%;
                            width: <%= [[(span[:duration_ms].to_f / @trace.duration_ms * 100).round(2), 0.5].max, 100].min %>%;
                            background: <%= span_kind_color(span[:kind]) %>;">
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <% if @trace.spans.empty? %>
        <div class="p-8 text-center text-[14px]" style="color: #8B8780;">
          No spans recorded
        </div>
      <% end %>
    </div>
  </div>

  <!-- Context -->
  <div class="rounded-xl p-5" style="background: #FFFFFE; border: 1px solid #E8E5E0;">
    <h3 class="text-[14px] font-medium mb-4" style="color: #1A1A1A;">Context</h3>
    <div class="grid grid-cols-2 gap-x-8 gap-y-1 text-[13px]">
      <div class="flex justify-between py-2" style="border-bottom: 1px solid #F0EFED;">
        <span style="color: #8B8780;">Trace ID</span>
        <span class="font-mono truncate ml-4" style="color: #1A1A1A;"><%= @trace.trace_id %></span>
      </div>
      <div class="flex justify-between py-2" style="border-bottom: 1px solid #F0EFED;">
        <span style="color: #8B8780;">Request ID</span>
        <span class="font-mono truncate ml-4" style="color: #1A1A1A;"><%= @trace.request_id || '-' %></span>
      </div>
      <div class="flex justify-between py-2" style="border-bottom: 1px solid #F0EFED;">
        <span style="color: #8B8780;">Controller</span>
        <span style="color: #1A1A1A;"><%= @trace.controller || '-' %></span>
      </div>
      <div class="flex justify-between py-2" style="border-bottom: 1px solid #F0EFED;">
        <span style="color: #8B8780;">Action</span>
        <span style="color: #1A1A1A;"><%= @trace.action || '-' %></span>
      </div>
      <div class="flex justify-between py-2" style="border-bottom: 1px solid #F0EFED;">
        <span style="color: #8B8780;">Host</span>
        <span style="color: #1A1A1A;"><%= @trace.host || '-' %></span>
      </div>
      <div class="flex justify-between py-2" style="border-bottom: 1px solid #F0EFED;">
        <span style="color: #8B8780;">Commit</span>
        <span class="font-mono" style="color: #1A1A1A;"><%= @trace.commit || '-' %></span>
      </div>
      <% if @trace.user_id %>
        <div class="flex justify-between py-2" style="border-bottom: 1px solid #F0EFED;">
          <span style="color: #8B8780;">User ID</span>
          <span style="color: #1A1A1A;"><%= @trace.user_id %></span>
        </div>
      <% end %>
    </div>
  </div>
</div>
